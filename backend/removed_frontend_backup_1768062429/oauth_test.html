<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=DM+Sans:400,500,700&display=swap" rel="stylesheet">
  <title>OAuth Link Test â€” TimelinePlus</title>
  <script>
    // Replace with your actual FB App ID and API version
    const FB_APP_ID = '{your-facebook-app-id}';
    const FB_API_VERSION = 'v17.0';
  </script>
</head>
<body>
  <h2>Facebook Login (Client-side SDK)</h2>
  <div id="fb-root"></div>
  <fb:login-button scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button>
  <div id="fb-status"></div>

  <h2>Google Sign-In (Client-side)</h2>
  <div id="g_id_onload"
       data-client_id="{your-google-client-id}"
       data-login_uri="/" 
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>

  <script>
    // Facebook SDK
    window.fbAsyncInit = function() {
      FB.init({
        appId      : FB_APP_ID,
        cookie     : true,
        xfbml      : true,
        version    : FB_API_VERSION
      });
      FB.AppEvents.logPageView();
      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));

    function statusChangeCallback(response) {
      const el = document.getElementById('fb-status');
      if (response.status === 'connected') {
        el.innerText = 'Connected to Facebook';
        // send access token to backend for linking
        const token = response.authResponse.accessToken;
        fetch('/api/link/facebook', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // include bearer token for auth if your user is logged in
            'Authorization': 'Bearer {user-jwt-token}'
          },
          body: JSON.stringify({ accessToken: token })
        }).then(r=>r.json()).then(console.log).catch(console.error);
      } else {
        el.innerText = 'Not connected to Facebook';
      }
    }

    function checkLoginState() {
      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    }

    // Google one-tap & button will call a global function on success - define handler
    // See Google Identity Services docs for details and add your client_id above
    function handleCredentialResponse(response) {
      // response.credential contains the ID token
      const idToken = response.credential;
      fetch('/api/link/google', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer {user-jwt-token}' },
        body: JSON.stringify({ idToken })
      }).then(r=>r.json()).then(console.log).catch(console.error);
    }

    // load Google Identity Services
    (function() {
      const s = document.createElement('script');
      s.src = 'https://accounts.google.com/gsi/client';
      s.onload = () => {
        window.google.accounts.id.initialize({ client_id: '{your-google-client-id}', callback: handleCredentialResponse });
        window.google.accounts.id.renderButton(document.body, { theme: 'outline', size: 'large' });
      };
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>